<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BioGuard • Spin to Win</title>
  <style>
    :root{
      --bg:#071427;
      --card: rgba(10,25,50,0.78);
      --line:rgba(255,255,255,0.12);
      --text:#f5f7ff;
      --muted:#a9b4d6;
      --gold:#ffd166;
      --good: rgba(38,194,129,0.18);
      --bad: rgba(255,92,116,0.14);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 50% 0%, #0e2a57 0%, var(--bg) 65%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .wrap{width:min(1100px, 100%);display:grid;gap:16px;}
    .top{
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;
      padding:16px 18px;border:1px solid var(--line);border-radius:18px;
      background: var(--card);backdrop-filter: blur(6px);
    }
    .title{display:flex;flex-direction:column;gap:6px;}
    h1{margin:0;font-size: clamp(20px, 2.5vw, 30px);letter-spacing:0.2px;}
    .sub{color:var(--muted);font-size:14px;line-height:1.3;}
    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center;}
    button{
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(15,42,85,0.7);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:0.2px;
    }
    button:hover{ background: rgba(21,57,111,0.82); }
    .btnPrimary{background: var(--good);border-color: rgba(38,194,129,0.35);}
    .btnDanger{background: var(--bad);border-color: rgba(255,92,116,0.30);}

    .main{display:grid;grid-template-columns: 1.2fr 0.8fr;gap:16px;}
    @media (max-width: 980px){ .main{ grid-template-columns: 1fr; } }

    .wheelCard{
      border:1px solid var(--line);border-radius:18px;background: var(--card);
      padding:18px;display:grid;gap:14px;align-items:center;justify-items:center;
    }
    .wheelWrap{
      position:relative;
      width:min(560px, 92vw);
      aspect-ratio:1/1;
      display:grid;
      place-items:center;
    }
    canvas{
      width:100%;height:100%;
      border-radius:50%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.02);
      position:relative;
      z-index:1;
    }
    .pointer{
      position:absolute;top:-6px;left:50%;transform: translateX(-50%);
      width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;
      border-top:32px solid var(--gold);
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.35));
      z-index:5;
      pointer-events:none;
    }

    /* CENTER LOGO IS CLICKABLE */
    .centerSpin{
      position:absolute;
      width:32%;
      aspect-ratio:1/1;
      border-radius:50%;
      background: rgba(7,20,39,0.86);
      border: 1px solid rgba(255,255,255,0.18);
      display:grid;
      place-items:center;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      overflow:hidden;
      z-index:10;
      cursor:pointer;
      user-select:none;
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
      pointer-events:auto;
    }
    .centerSpin:hover{
      background: rgba(7,20,39,0.92);
      box-shadow: 0 14px 34px rgba(0,0,0,0.45);
    }
    .centerSpin:active{ transform: scale(0.98); }
    .centerSpin[aria-disabled="true"]{ cursor:not-allowed; opacity:0.85; transform:none; }

    .centerSpin img{width:95%;height:auto;opacity:0.96;display:none;pointer-events:none;}
    .centerText{font-weight:900;color:var(--gold);text-align:center;line-height:1.1;padding:10px;letter-spacing:0.4px;pointer-events:none;}

    .spinRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center;}
    .status{color:var(--muted);font-size:13px;text-align:center;}

    .side{
      border:1px solid var(--line);border-radius:18px;background: var(--card);
      padding:16px;display:flex;flex-direction:column;gap:12px;
    }
    .cardTitle{display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .pill{
      font-size:12px;color: var(--muted);border:1px solid rgba(255,255,255,0.12);
      padding:6px 10px;border-radius:999px;background: rgba(255,255,255,0.04);white-space:nowrap;
    }
    .list{display:flex;flex-direction:column;gap:8px;max-height: 360px;overflow:auto;padding-right:4px;}
    .item{
      border:1px solid rgba(255,255,255,0.10);background: rgba(15,42,85,0.55);
      border-radius:14px;padding:10px 12px;display:flex;justify-content:space-between;gap:10px;align-items:center;
    }
    .item b{ color: var(--text); }
    .item span{ color: var(--muted); font-size:12px; }

    .winner{
      border:1px solid rgba(255,209,102,0.30);background: rgba(255,209,102,0.12);
      border-radius:16px;padding:12px;
    }
    .winner h2{margin:0 0 4px 0;font-size:18px;color:var(--gold);}
    .winner p{margin:0;color:var(--text);font-weight:800;font-size:22px;letter-spacing:0.2px;}
    .fine{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35;}

    /* ===== MODAL (SCROLL FIXES) ===== */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;

      /* allow scrolling if modal taller than viewport */
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal{
      width:min(900px, 100%);
      background: rgba(10,25,50,0.95);
      border:1px solid rgba(255,255,255,0.14);
      border-radius:18px;
      box-shadow: 0 30px 90px rgba(0,0,0,0.55);

      /* key: keep within viewport */
      max-height: calc(100vh - 36px);
      display:flex;
      flex-direction:column;
      overflow:hidden; /* internal scrolling areas handle overflow */
    }
    .modalHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      flex: 0 0 auto;
    }
    .modalHead h3{margin:0;font-size:18px}

    .modalBody{
      padding:12px 14px 14px 14px;
      overflow:auto; /* ✅ modal body scrolls */
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
    }

    .grid{display:grid;grid-template-columns: 1.2fr 0.4fr 0.6fr;gap:10px;align-items:center;}
    @media (max-width: 720px){
      .grid{grid-template-columns: 1fr;}
    }

    input{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      outline:none;
    }

    .row{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(15,42,85,0.45);
      border-radius:14px;
      padding:10px;
      margin-bottom:10px;
    }
    .rowBtns{display:flex;gap:8px;justify-content:flex-end;padding:10px 0 0 0;border-top:1px solid rgba(255,255,255,0.10);margin-top:10px;}
    .dangerMini{background: rgba(255,92,116,0.14);border-color: rgba(255,92,116,0.30);}

    /* confetti */
    .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:60;display:none;}
    .confetti i{position:absolute;top:-20px;width:10px;height:14px;opacity:0.9;border-radius:2px;animation: fall 1400ms linear forwards;}
    @keyframes fall{to{ transform: translateY(calc(100vh + 60px)) rotate(720deg); }}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>BioGuard • Spin to Win</h1>
        <div class="sub">Click the <b>center BioGuard logo</b> to spin. Edit prizes with a PIN.</div>
      </div>
      <div class="controls">
        <button id="btnEdit" type="button">Edit Prizes (PIN)</button>
        <button id="btnReset" class="btnDanger" type="button">Reset Prizes</button>
        <button id="btnFull" type="button">Full Screen</button>
        <button id="btnClear" class="btnPrimary" type="button">Clear Winner</button>
      </div>
    </div>

    <div class="main">
      <div class="wheelCard">
        <div class="wheelWrap">
          <div class="pointer"></div>
          <canvas id="wheel" width="900" height="900"></canvas>

          <div id="centerSpin" class="centerSpin" role="button" tabindex="0" aria-label="Spin the wheel" aria-disabled="false" title="Click to spin">
            <img id="centerLogo" src="bioguard-logo.png" alt="BioGuard">
            <div id="centerText" class="centerText">SPIN<br>TO WIN</div>
          </div>
        </div>

        <div id="status" class="status">Ready.</div>
        <div class="fine">Tip: you can also press <b>Enter</b> while the center is focused.</div>
      </div>

      <div class="side">
        <div class="cardTitle">
          <b>Current Prize List</b>
          <span class="pill">Autosaves on this device</span>
        </div>

        <div class="winner" id="winnerBox" style="display:none;">
          <h2>Winner!</h2>
          <p id="winnerText"></p>
          <div class="fine" id="winnerFine"></div>
        </div>

        <div class="list" id="prizeList"></div>

        <div class="fine">
          Spins rotate <b>at least 5 full turns</b>. Labels are <b>wrapped + auto sized</b>.
        </div>
      </div>
    </div>
  </div>

  <div class="confetti" id="confetti"></div>

  <!-- MODAL -->
  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Edit prizes dialog">
      <div class="modalHead">
        <h3>Manage Prizes</h3>
        <div style="display:flex; gap:10px; align-items:center;">
          <span class="pill">PIN required</span>
          <button id="btnClose" type="button">Close</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="row">
          <div class="gridHead grid" style="margin-bottom:8px;">
            <div>Prize text</div>
            <div>Weight</div>
            <div>Fine print (optional)</div>
          </div>
          <div id="rows"></div>
          <div class="rowBtns">
            <button id="btnAdd" type="button">+ Add Prize</button>
            <button id="btnSave" class="btnPrimary" type="button">Save</button>
          </div>
        </div>

        <div class="row">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <b>Manager PIN</b>
            <span class="pill">Default is 1234</span>
          </div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
            <input id="pinNew" type="password" placeholder="New PIN (4–8 digits)" inputmode="numeric" />
            <input id="pinNew2" type="password" placeholder="Confirm new PIN" inputmode="numeric" />
          </div>
          <div class="rowBtns">
            <button id="btnSetPin" class="btnPrimary" type="button">Update PIN</button>
          </div>
          <div class="fine" id="pinMsg"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/********************
 * STORAGE + DEFAULTS
 ********************/
const LS_PRIZES = "bg_spin_prizes_v7";
const LS_PIN    = "bg_spin_pin_v7";
const DEFAULT_PIN = "1234";

const DEFAULT_PRIZES = [
  { label: "$5 OFF", weight: 8, fine: "Valid today only. One per customer." },
  { label: "$10 OFF", weight: 5, fine: "Valid today only. One per customer." },
  { label: "5% OFF TOTAL PURCHASE", weight: 6, fine: "Applies to regular-priced items." },
  { label: "10% OFF TOTAL PURCHASE", weight: 3, fine: "Applies to regular-priced items." },
  { label: "FREE WATER TEST", weight: 6, fine: "Stop by the counter anytime." },
  { label: "FREE SHOCK WITH PURCHASE", weight: 2, fine: "With qualifying purchase." },
  { label: "$25 STORE CREDIT", weight: 1, fine: "One winner tonight!" }
];

function clampInt(v, min, max){
  const n = parseInt(v, 10);
  if(Number.isNaN(n)) return min;
  return Math.max(min, Math.min(max, n));
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function loadPrizes(){
  try{
    const raw = localStorage.getItem(LS_PRIZES);
    if(!raw) return structuredClone(DEFAULT_PRIZES);
    const parsed = JSON.parse(raw);
    if(!Array.isArray(parsed) || parsed.length < 2) return structuredClone(DEFAULT_PRIZES);
    return parsed.map(p => ({
      label: String(p.label ?? "").trim().slice(0, 80) || "PRIZE",
      weight: clampInt(p.weight ?? 1, 1, 50),
      fine: String(p.fine ?? "").trim().slice(0, 180)
    }));
  }catch{
    return structuredClone(DEFAULT_PRIZES);
  }
}
function savePrizes(prizes){ localStorage.setItem(LS_PRIZES, JSON.stringify(prizes)); }
function loadPin(){
  const saved = localStorage.getItem(LS_PIN);
  return (saved && saved.trim()) ? saved.trim() : DEFAULT_PIN;
}
function savePin(pin){ localStorage.setItem(LS_PIN, pin); }

/********************
 * UI
 ********************/
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");

const statusEl = document.getElementById("status");
const prizeListEl = document.getElementById("prizeList");
const winnerBox = document.getElementById("winnerBox");
const winnerText = document.getElementById("winnerText");
const winnerFine = document.getElementById("winnerFine");

const btnEdit = document.getElementById("btnEdit");
const btnReset = document.getElementById("btnReset");
const btnFull = document.getElementById("btnFull");
const btnClear = document.getElementById("btnClear");

const modalBack = document.getElementById("modalBack");
const btnClose = document.getElementById("btnClose");
const rowsEl = document.getElementById("rows");
const btnAdd = document.getElementById("btnAdd");
const btnSave = document.getElementById("btnSave");

const pinNew = document.getElementById("pinNew");
const pinNew2 = document.getElementById("pinNew2");
const btnSetPin = document.getElementById("btnSetPin");
const pinMsg = document.getElementById("pinMsg");

const confetti = document.getElementById("confetti");

const centerSpin = document.getElementById("centerSpin");
const centerLogo = document.getElementById("centerLogo");
const centerText = document.getElementById("centerText");
centerLogo.addEventListener("load", () => { centerLogo.style.display = "block"; centerText.style.display = "none"; });
centerLogo.addEventListener("error", () => { centerLogo.style.display = "none"; centerText.style.display = "block"; });

/********************
 * STATE
 ********************/
let prizes = loadPrizes();
let spinAngle = 0;
let spinning = false;
let lastWinnerIndex = null;

function setCenterEnabled(enabled){
  centerSpin.setAttribute("aria-disabled", enabled ? "false" : "true");
  centerSpin.style.pointerEvents = enabled ? "auto" : "none";
  centerSpin.style.opacity = enabled ? "1" : "0.86";
}

/********************
 * SEGMENTS
 ********************/
function totalWeight(){ return prizes.reduce((sum,p)=>sum + (p.weight||1), 0); }
function buildSegments(){
  const total = totalWeight();
  let a = 0;
  return prizes.map(p => {
    const span = (p.weight / total) * Math.PI * 2;
    const seg = { ...p, start:a, end:a + span };
    a += span;
    return seg;
  });
}
function winnerFromAngle(angle){
  const twoPi = Math.PI * 2;
  let hit = (-angle) % twoPi;
  if(hit < 0) hit += twoPi;
  const segs = buildSegments();
  for(let i=0;i<segs.length;i++){
    if(hit >= segs[i].start && hit < segs[i].end) return i;
  }
  return 0;
}

/********************
 * LABEL WRAP + AUTO SIZE
 ********************/
function fontPxFor(text){
  const n = String(text).length;
  if(n <= 10) return 38;
  if(n <= 16) return 34;
  if(n <= 22) return 30;
  if(n <= 32) return 26;
  if(n <= 44) return 22;
  return 19;
}
function wrapLines(ctx, text, maxWidth){
  const words = String(text).split(/\s+/).filter(Boolean);
  const lines = [];
  let line = "";
  for(const w of words){
    const test = line ? (line + " " + w) : w;
    if(ctx.measureText(test).width <= maxWidth) line = test;
    else { if(line) lines.push(line); line = w; }
  }
  if(line) lines.push(line);
  if(lines.length > 3){
    const l1 = lines[0] || "";
    const l2 = lines[1] || "";
    let l3 = lines.slice(2).join(" ");
    while(ctx.measureText(l3 + "…").width > maxWidth && l3.length > 0) l3 = l3.slice(0,-1);
    return [l1, l2, (l3 ? l3 : "").trim() + "…"];
  }
  return lines;
}
function drawWrappedLabel(ctx, text, maxWidth){
  let px = fontPxFor(text);
  for(let attempt=0; attempt<7; attempt++){
    ctx.font = `900 ${px}px system-ui`;
    const lines = wrapLines(ctx, text, maxWidth);
    const lineH = px * 1.05;
    const totalH = lines.length * lineH;
    if(totalH <= px * 3.3){
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      const startY = -((lines.length - 1) * lineH)/2;
      for(let i=0;i<lines.length;i++){
        ctx.fillText(lines[i], 0, startY + i*lineH);
      }
      return;
    }
    px -= 3;
  }
  ctx.font = "900 18px system-ui";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  const t = String(text);
  ctx.fillText(t.slice(0,18) + (t.length>18 ? "…" : ""), 0, 0);
}

/********************
 * DRAW
 ********************/
function drawWheel(){
  const segs = buildSegments();
  const w = canvas.width, h = canvas.height;
  const cx = w/2, cy = h/2;
  const r = Math.min(cx, cy) - 18;

  ctx.clearRect(0,0,w,h);

  ctx.beginPath();
  ctx.arc(cx,cy,r+8,0,Math.PI*2);
  ctx.strokeStyle = "rgba(255,255,255,0.16)";
  ctx.lineWidth = 10;
  ctx.stroke();

  const palette = ["#143b77","#0f2a55","#18458a","#0c2350","#1b4d99","#102f61","#173f80","#0b1f44"];

  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(spinAngle);

  let i=0;
  for(const s of segs){
    const color = palette[i % palette.length];

    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,r, s.start - Math.PI/2, s.end - Math.PI/2);
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();

    ctx.strokeStyle = "rgba(255,255,255,0.14)";
    ctx.lineWidth = 2;
    ctx.stroke();

    const mid = (s.start + s.end)/2 - Math.PI/2;
    ctx.save();
    ctx.rotate(mid);
    ctx.translate(r*0.62, 0);

    const midNorm = (mid % (Math.PI*2) + Math.PI*2) % (Math.PI*2);
    const flip = (midNorm > Math.PI/2 && midNorm < 3*Math.PI/2);
    ctx.rotate(flip ? Math.PI : 0);

    ctx.rotate(Math.PI/2);
    ctx.fillStyle = "#ffd166";
    const maxWidth = r * 0.30;
    drawWrappedLabel(ctx, s.label, maxWidth);

    ctx.restore();
    i++;
  }
  ctx.restore();

  ctx.beginPath();
  ctx.arc(cx,cy,r*0.32,0,Math.PI*2);
  ctx.fillStyle = "rgba(7,20,39,0.72)";
  ctx.fill();
  ctx.strokeStyle = "rgba(255,255,255,0.18)";
  ctx.lineWidth = 4;
  ctx.stroke();

  ctx.beginPath();
  ctx.arc(cx,cy,r*0.34,0,Math.PI*2);
  ctx.strokeStyle = "rgba(255,209,102,0.12)";
  ctx.lineWidth = 10;
  ctx.stroke();
}

function renderPrizeList(){
  prizeListEl.innerHTML = "";
  prizes.forEach((p) => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `<div><b>${escapeHtml(p.label)}</b><div><span>Weight: ${p.weight}</span></div></div>
      <div style="text-align:right"><span>${p.fine ? escapeHtml(p.fine) : ""}</span></div>`;
    prizeListEl.appendChild(div);
  });
}

/********************
 * SPIN (5+ FULL TURNS)
 ********************/
async function spin(){
  if(spinning) return;
  if(prizes.length < 2){
    alert("Add at least 2 prizes.");
    return;
  }
  spinning = true;
  setCenterEnabled(false);
  winnerBox.style.display = "none";
  statusEl.textContent = "Spinning...";

  const segs = buildSegments();
  const total = totalWeight();

  let targetIndex = 0;
  for(let tries=0; tries<30; tries++){
    let pick = Math.random() * total;
    for(let i=0;i<segs.length;i++){
      pick -= segs[i].weight;
      if(pick <= 0){ targetIndex = i; break; }
    }
    if(lastWinnerIndex === null || targetIndex !== lastWinnerIndex) break;
  }

  const span = segs[targetIndex].end - segs[targetIndex].start;
  const pad = Math.max(0.01, span * 0.12);
  const within = segs[targetIndex].start + pad + Math.random() * Math.max(0.0001, span - 2*pad);
  const targetBase = -within;

  const minSpins = 5;
  const extraSpins = Math.floor(Math.random() * 4);
  const fullTurns = minSpins + extraSpins;

  const twoPi = Math.PI * 2;
  const start = spinAngle;
  const minEnd = start + fullTurns * twoPi;
  const m = Math.ceil((minEnd - targetBase) / twoPi);
  const end = targetBase + m * twoPi;

  const dur = 1800 + fullTurns * 220;
  const t0 = performance.now();
  const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

  await new Promise(resolve => {
    const step = (now) => {
      const t = Math.min(1, (now - t0) / dur);
      const e = easeOutCubic(t);
      spinAngle = start + (end - start) * e;
      drawWheel();
      if(t < 1) requestAnimationFrame(step);
      else resolve();
    };
    requestAnimationFrame(step);
  });

  const idx = winnerFromAngle(spinAngle);
  lastWinnerIndex = idx;

  const win = prizes[idx];
  winnerText.textContent = win.label;
  winnerFine.textContent = win.fine || "";
  winnerBox.style.display = "block";
  statusEl.textContent = "Winner selected.";

  popConfetti(120);
  spinning = false;
  setCenterEnabled(true);
}

function popConfetti(n=90){
  confetti.innerHTML = "";
  confetti.style.display = "block";
  const colors = ["#ffd166","#26c281","#5cc8ff","#ff5c74","#ffffff"];
  for(let i=0;i<n;i++){
    const p = document.createElement("i");
    p.style.left = (Math.random()*100) + "vw";
    const size = 6 + Math.random()*10;
    p.style.width = size + "px";
    p.style.height = (size*1.2) + "px";
    p.style.background = colors[i % colors.length];
    p.style.animationDelay = (Math.random()*180) + "ms";
    confetti.appendChild(p);
  }
  setTimeout(()=>{ confetti.style.display = "none"; }, 1600);
}

/********************
 * MODAL (EDIT PRIZES) — SCROLLABLE
 ********************/
function openModal(){
  modalBack.style.display = "flex";
  modalBack.setAttribute("aria-hidden","false");
  buildRows();
}
function closeModal(){
  modalBack.style.display = "none";
  modalBack.setAttribute("aria-hidden","true");
  pinNew.value=""; pinNew2.value="";
  pinMsg.textContent="";
}
function askPinThen(cb){
  const savedPin = loadPin();
  const entered = prompt("Enter manager PIN:");
  if(entered === null) return;
  if(String(entered).trim() !== savedPin){
    alert("Incorrect PIN.");
    return;
  }
  cb();
}

function addRow(p={label:"", weight:1, fine:""}){
  const row = document.createElement("div");
  row.className = "row";
  row.innerHTML = `
    <div class="grid">
      <input class="inLabel" placeholder="e.g., $5 OFF" value="${escapeHtml(p.label)}" />
      <input class="inWeight" type="number" min="1" max="50" value="${p.weight ?? 1}" />
      <input class="inFine" placeholder="Optional fine print" value="${escapeHtml(p.fine||"")}" />
    </div>
    <div class="rowBtns">
      <button type="button" class="btnDel dangerMini">Remove</button>
    </div>
  `;
  row.querySelector(".btnDel").addEventListener("click", () => row.remove());
  rowsEl.appendChild(row);
}
function buildRows(){
  rowsEl.innerHTML = "";
  prizes.forEach(p => addRow(p));
}
function collectRows(){
  const rows = [...rowsEl.querySelectorAll(".row")];
  const next = [];
  for(const r of rows){
    const label = r.querySelector(".inLabel").value.trim().slice(0,80);
    const weight = clampInt(r.querySelector(".inWeight").value, 1, 50);
    const fine = r.querySelector(".inFine").value.trim().slice(0,180);
    if(label) next.push({ label, weight, fine });
  }
  return next;
}

/********************
 * EVENTS
 ********************/
centerSpin.addEventListener("click", (e) => { e.preventDefault(); spin(); });
centerSpin.addEventListener("keydown", (e) => {
  if(e.key === "Enter" || e.key === " "){
    e.preventDefault();
    spin();
  }
});

btnClear.addEventListener("click", () => {
  if(spinning) return;
  winnerBox.style.display = "none";
  statusEl.textContent = "Ready.";
});

btnEdit.addEventListener("click", () => askPinThen(openModal));

btnReset.addEventListener("click", () => {
  askPinThen(() => {
    if(confirm("Reset prizes to defaults?")){
      prizes = structuredClone(DEFAULT_PRIZES);
      savePrizes(prizes);
      renderPrizeList();
      drawWheel();
      statusEl.textContent = "Prizes reset.";
    }
  });
});

btnFull.addEventListener("click", async () => {
  try{
    if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  }catch{
    alert("Fullscreen not available in this browser.");
  }
});

btnClose.addEventListener("click", closeModal);
modalBack.addEventListener("click", (e) => { if(e.target === modalBack) closeModal(); });

btnAdd.addEventListener("click", () => addRow({label:"", weight:1, fine:""}));

btnSave.addEventListener("click", () => {
  const next = collectRows();
  if(next.length < 2){
    alert("Please keep at least 2 prizes.");
    return;
  }
  prizes = next;
  savePrizes(prizes);
  renderPrizeList();
  drawWheel();
  statusEl.textContent = "Prizes saved.";
  closeModal();
});

btnSetPin.addEventListener("click", () => {
  const a = pinNew.value.trim();
  const b = pinNew2.value.trim();
  if(!a || !b){ pinMsg.textContent = "Enter and confirm your new PIN."; return; }
  if(a !== b){ pinMsg.textContent = "PINs do not match."; return; }
  if(!/^\d{4,8}$/.test(a)){ pinMsg.textContent = "PIN must be 4–8 digits."; return; }
  savePin(a);
  pinMsg.textContent = "PIN updated successfully.";
  pinNew.value = "";
  pinNew2.value = "";
});

/********************
 * INIT
 ********************/
renderPrizeList();
drawWheel();
statusEl.textContent = "Ready. Click the center logo to spin.";
setCenterEnabled(true);
</script>
</body>
</html>
